<style>
    * {
        font-family: monospace;
    }
    
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ccc;
        display: flex;
        align-items: center;
        padding: 0 10px;
        z-index: 100;
        width: 100%;
        overflow-x: auto;
    }

    #actions-bar {
        position: fixed;
        top: 50px;
        left: 0;
        right: 0;
        height: 35px;
        background-color: #f8f8f8;
        border-bottom: 1px solid #ccc;
        display: flex;
        align-items: center;
        padding: 0 2.5px;
    }

    #container {
        position: absolute;
        top: 85px;
        left: 0;
        right: 0;
        bottom: 0;
        box-sizing: border-box;
        padding: 10px;
    }

    iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .tab {
        display: inline-block;
        padding: 10px;
        background-color: #e0e0e0;
        border: 1px solid #ccc;
        margin-right: 5px;
        cursor: pointer;
        font-size: 16px;
        user-select: none;
    }

    .action-tab {
        display: inline-block;
        background-color: #e0e0e0;
        border: 1px solid #ccc;
        cursor: pointer;
        font-size: 14px;
        user-select: none;
        padding: 0 5px;
        height: 25px;
        line-height: 25px;
        margin-right: 5px;
    }

    .action-tab:hover {
        background-color: #d0d0d0;
    }

    .selected {
        background-color: #d0d0d0;
        border-bottom: 2px solid #007bff;
    }

    .hidden {
        display: none;
    }

    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
</style>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/14.5.3/math.js"></script>
</head>
<body>
    <div id="loading-screen">
        <h1>Loading...</h1>
    </div>
    <div id="top-bar">
    </div>
    <div id="actions-bar">
        <div class="action-tab" id="new">New Tab</div>
        <div class="action-tab" id="delete">Delete Current Tab</div>
        <div class="action-tab" id="export">Export Tabs</div>
        <div class="action-tab" id="import">Import Tabs</div>
    </div>
    <div id="container"></div>
</body>
 
<script>
    let topBar = document.getElementById('top-bar');
    let container = document.getElementById('container');

    let deleteButton = document.getElementById('delete');
    let exportButton = document.getElementById('export');
    let importButton = document.getElementById('import');
    let newTabButton = document.getElementById('new');

    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.style.display = 'none'; // Hide the loading screen after everything is loaded

    let clickTimer = null;

    let tabCounter = 0;

    function sendToAllTabs(message){
        let iframes = document.querySelectorAll('iframe');
        iframes.forEach(iframe => {
            iframe.contentWindow.postMessage(message, '*');
        });
    }

    function createTabAndNotepad(){
        tabCounter++;

        let newTab = document.createElement('div');
        newTab.classList.add('tab');
        newTab.textContent = `Tab ${tabCounter}`;
        newTab.setAttribute('data-tab', tabCounter);

        let notepad = document.createElement('iframe');
        notepad.src = '/notepad.html';
        notepad.id = `notepad-${tabCounter}`;
        notepad.style.display = 'none';

        let tabs = document.querySelectorAll('.tab');
        tabs.forEach(t => t.classList.remove('selected'));
        newTab.classList.add('selected');

        newTab.addEventListener('click', () => {
            let tabs = document.querySelectorAll('.tab');
            let iframes = document.querySelectorAll('iframe');

            tabs.forEach(t => {
                document.getElementById(`notepad-${t.getAttribute('data-tab')}`).style.display = 'none';
            });

            document.getElementById(`notepad-${newTab.getAttribute('data-tab')}`).style.display = 'block';

            tabs.forEach(t => t.classList.remove('selected'));
            newTab.classList.add('selected');
        });

        newTab.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            let newName = prompt("Enter new name for the tab:", newTab.textContent);
            if (newName) {
                newTab.textContent = newName;
            }
        });

        // find the active tab if there is one, otherwise append
        let activeTab = document.querySelector('.tab.selected');
        if (activeTab) {
            activeTab.insertAdjacentElement('afterend', newTab);
        } else {
            topBar.appendChild(newTab);
        }
        container.appendChild(notepad);
        newTab.click();
    }

    newTabButton.addEventListener('click', () => {
        let tabs = document.querySelectorAll('.tab');
        createTabAndNotepad();
    });

    deleteButton.addEventListener('click', () => {
        let tabs = document.querySelectorAll('.tab');

        if(tabs.length > 1) {
            let selectedTab = document.querySelector('.tab.selected');
            let selectedNotepad = document.querySelector(`#notepad-${selectedTab.getAttribute('data-tab')}`);


            selectedTab.remove();
            selectedNotepad.remove();
        }
    });

    exportButton.addEventListener('click', () => {
        let tabs = Array.from(document.querySelectorAll('.tab'));

        let exportData = tabs.map(tab => {
            let tabNumber = tab.getAttribute('data-tab');

            let notepadElement = document.querySelector(`#notepad-${tabNumber} iframe`).contentWindow.document.body;

            let notepadContent = notepadElement.querySelector('#notes').textContent;

            return {
                name: tab.textContent,
                content: notepadContent
            };
        });
        
        
        let fileContent = JSON.stringify(exportData, null, 4);
        let blob = new Blob([fileContent], { type: "application/json" });
        let url = URL.createObjectURL(blob);

        let a = document.createElement("a");
        a.href = url;
        a.download = "tabs.json";
        a.click();

        URL.revokeObjectURL(url); 
    });

    importButton.addEventListener('click', () => {
        let fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';

        fileInput.addEventListener('change', (event) => {
            let file = event.target.files[0];
            if (file) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    loadingScreen.style.display = 'flex';
                    tabCounter = 0;
                    
                    // artifical delay
                    setTimeout(() => {
                        let data = JSON.parse(e.target.result);

                        let tabs = document.querySelectorAll('.tab');

                        // delete all tabs
                        tabs.forEach(tab => {
                            document.querySelector(`#notepad-${tab.getAttribute('data-tab')}`).remove();
                            tab.remove()
                        });

                        data.forEach(() => {
                            createTabAndNotepad()
                        })

                        let newTabs = document.querySelectorAll('.tab');
                        newTabs.forEach((tab, index) => {
                            tab.textContent = data[index].name;
                            tab.setAttribute('data-tab', index + 1);


                            let notepadElement = document.querySelector(`#notepad-${index + 1}`).contentWindow.document.body;

                            if (index === 0) {
                                tab.classList.add('selected');
                                notepadElement.classList.remove('hidden');
                            } else {
                                notepadElement.classList.add('hidden');
                            }
                        });
                        newTabs.forEach((tab, index) => {
                            tab.textContent = data[index].name;
                            tab.setAttribute('data-tab', index + 1);

                            let notepadElement = document.querySelector(`#notepad-${index + 1}`).contentWindow.document.body;

                            if (index === 0) {
                                tab.classList.add('selected');
                                notepadElement.classList.remove('hidden');
                            } else {
                                notepadElement.classList.add('hidden');
                            }
                        });

                        setTimeout(() => {
                            newTabs.forEach((tab, index) => {
                                let notepadElement = document.querySelector(`#notepad-${index + 1}`).contentWindow.document.body;
                                
                                let notes = notepadElement.querySelector('#notes');
                                notes.textContent = data[index].content;
                            })
                            loadingScreen.style.display = 'none';
                        }, 200 * newTabs.length);

                        newTabs[0].click()
                    }, 500)
                    
                };
                reader.readAsText(file);
            }
        });

        fileInput.click();
    });

    createTabAndNotepad(); // Create the first tab and notepad on load
</script>